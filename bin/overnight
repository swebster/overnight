#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'overnight/nightscout'

nightscout = Overnight::Nightscout.new

Signal.trap('INT') do
  puts
  exit 130
end

loop do
  data = nightscout.get
  current = data[:entry].first
  loop = data[:device_status].first

  min_max = loop.predicted.first(12).minmax
  s = format('%s: ', current.time.localtime.strftime('%F %T'))
  puts s << [current, *min_max].map { |m| format('%4.1f', m.glucose) }.join(', ')

  # TODO: replace with a proper timer to prevent drift
  sleep(60 * 5)
end
