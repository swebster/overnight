#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'overnight/pushover'
require 'overnight/pushover/options'

def post_message(pushover, message, **)
  receipt = pushover.post(message, **)
  return unless receipt && pushover.group_notifications?

  loop do
    sleep 5
    if (status = pushover.check_status(receipt))
      return pushover.publish_response(status)
    end
  end
end

def execute_command(pushover, options)
  if options.empty?
    pushover.list_groups
  elsif options.key?(:message)
    post_message(pushover, options[:message], **options.slice(:priority))
  elsif options.key?(:group) && options.size == 1
    pushover.create_group_or_list_users(options[:group])
  else
    pushover.add_user(*options.fetch_values(*%i[group user name]))
  end
end

begin
  options = Overnight::Pushover::Options.parse
  execute_command(Overnight::Pushover.new, options)
rescue Overnight::Error => e
  warn e.message
end
