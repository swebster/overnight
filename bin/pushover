#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'overnight/pushover'
require 'overnight/pushover/options'

def wait_for_ack(pushover, receipt)
  loop do
    sleep 5
    if (status = pushover.check_status(receipt))
      return pushover.publish_response(status)
    end
  end
end

begin
  options = Overnight::Pushover::Options.parse
  pushover = Overnight::Pushover.new
  if options.empty?
    pushover.list_groups
  elsif options.key?(:message)
    receipt = pushover.post(options[:message], **options.slice(:priority))
    wait_for_ack(pushover, receipt) if receipt && pushover.using_group_key?
  elsif options.key?(:group) && options.size == 1
    group_name = options[:group]
    pushover.create_group_or_list_users(group_name)
  else
    values = options.fetch_values(*%i[group user name])
    pushover.add_user(*values)
  end
rescue Overnight::Error => e
  warn e.message
end
